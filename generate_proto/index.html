<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Generate Proto - Django Socio gRPC Documentation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../css/theme.css" />
  <link rel="stylesheet" href="../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Generate Proto";
    var mkdocs_page_input_path = "generate_proto.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Django Socio gRPC Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                    </li>
                </ul>
                <ul class="current">
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Generate Proto</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#command">Command</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#settings-configuration">Settings configuration</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#default-generation">Default generation</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#adding-custom-method-decorator">Adding Custom method (Decorator)</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#request-and-response-arg">Request and Response arg</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#request_name-and-response_name-arg">request_name and response_name arg</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#request_stream-and-response_stream-arg">request_stream and response_stream arg</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#use_request_list-and-use_response_list-arg">use_request_list and use_response_list arg</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#force-message-for-know-method">Force message for know method</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#read-only-and-write-only-props">Read Only and write only props</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#nested-serializer">Nested serializer</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#special-case-of-methodserializerfield">Special case of MethodSerializerField</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#customizing-the-name-of-the-field-in-the-listresponse">Customizing the name of the field in the ListResponse</a>
    </li>
    </ul>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../generic_service/">Generic Service</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../model_service/">Model Service</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../proto_serializer/">Proto Serializer</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../sync_vs_async/">Sync vs Async</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../server_and_service_register/">Server and service register</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../permissions_and_authentication/">Permissions and Authentication</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../settings/">Settings</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../testing/">Testing</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Django Socio gRPC Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Generate Proto</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>

          <div role="main">
            <div class="section">
              
                <h1 id="proto-generation">Proto Generation</h1>
<p>To be able to generate proto you need to register your service first. To do so please refer to <a href="https://socotecio.github.io/django-socio-grpc/server_and_service_register/#service-registration">https://socotecio.github.io/django-socio-grpc/server_and_service_register/#service-registration</a></p>
<h2 id="command">Command</h2>
<p>To automatically generate proto and python files use the generateproto command:</p>
<pre><code class="language-bash">python manage.py generateproto
</code></pre>
<p>Options Available:</p>
<table>
<thead>
<tr>
<th>Option</th>
<th>Shortcut</th>
<th>Default value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>--project</td>
<td>-p</td>
<td>Use DJANGO_SETTINGS_MODULE first folder</td>
<td>Name of the django project that is use in the proto package name.</td>
</tr>
<tr>
<td>--dry-run</td>
<td>-dr</td>
<td>False</td>
<td>Print in terminal the protofile content without writing it to a file or generate new python code.</td>
</tr>
<tr>
<td>--generate-python</td>
<td>-gp</td>
<td>True</td>
<td>Generate python file same time you generate proto file.</td>
</tr>
<tr>
<td>--check</td>
<td>-c</td>
<td>False</td>
<td>Check if the current protofile is the same that one that will be generated by a new command to be sur your api is sync with your models.</td>
</tr>
</tbody>
</table>
<h2 id="settings-configuration">Settings configuration</h2>
<p>As all the services are register at the launch of the server and not at the command level if we want to customize some behavior in the register process we need to use django settings.</p>
<table>
<thead>
<tr>
<th>Setting</th>
<th>Default value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GRPC_FRAMEWORK.SEPARATE_READ_WRITE_MODEL</td>
<td>True</td>
<td>use the field fonctionnality read_only and write_only to seperate request message and response message.</td>
</tr>
</tbody>
</table>
<p>For all the following example we will show result with default value of settings.</p>
<h2 id="default-generation">Default generation</h2>
<p>By default each service registered inheriting from know mixins will generate the default method and message in proto file. </p>
<p>For example if we have a service that inherit from AsyncModelService and serializer like this:</p>
<pre><code class="language-python"># Serializer
from django_socio_grpc import proto_serializers
from .models import Something


class SomethingProtoSerializer(proto_serializers.ModelProtoSerializer):
    class Meta:
        model = Something
        fields = [&quot;uuid&quot;, &quot;start_date&quot;, &quot;rate&quot;]

# Service
from django_socio_grpc import generics
from ..models import Something
from ..serializers import SomethingProtoSerializer


class SomethingService(generics.AsyncModelService):
    queryset = Something.objects.all()
    serializer_class = SomethingProtoSerializer

</code></pre>
<p>this will generate a proto like:</p>
<pre><code class="language-proto">syntax = &quot;proto3&quot;;

package doc_example.generate_proto_doc;

import &quot;google/protobuf/empty.proto&quot;;

service SomethingController {
    rpc List(SomethingListRequest) returns (SomethingListResponse) {}
    rpc Create(SomethingRequest) returns (SomethingResponse) {}
    rpc Retrieve(SomethingRetrieveRequest) returns (SomethingResponse) {}
    rpc Update(SomethingRequest) returns (SomethingResponse) {}
    rpc Destroy(SomethingDestroyRequest) returns (google.protobuf.Empty) {}
}

message SomethingResponse {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
}

message SomethingListRequest {
}

message SomethingListResponse {
    repeated SomethingResponse results = 1;
}

message SomethingRequest {
    string uuid = 1;
    string start_date = 2;
    string rate = 3;
}

message SomethingRetrieveRequest {
    string uuid = 1;
}

message SomethingDestroyRequest {
    string uuid = 1;
}
</code></pre>
<p>To see more complex usage without reading the doc please look at the code used for the unit tests:</p>
<p><a href="https://github.com/socotecio/django-socio-grpc/tree/master/django_socio_grpc/tests/fakeapp/services">See services example used for test here</a>
<a href="https://github.com/socotecio/django-socio-grpc/blob/master/django_socio_grpc/tests/fakeapp/serializers.py">See serializers example used for test here</a></p>
<h2 id="adding-custom-method-decorator">Adding Custom method (Decorator)</h2>
<p>You can add custome method (one not listed in mixins file: List, Create, Update, PartialUpdate, Retrieve, Delete, Stream) with the decorator grpc_action</p>
<p>This decorator signature is:</p>
<pre><code class="language-python">def grpc_action(request=None, response=None, request_name=None, response_name=None, request_stream=False, response_stream=False, use_request_list=False, use_response_list=False)
</code></pre>
<h3 id="request-and-response-arg">Request and Response arg</h3>
<p>request and response are the variable used to define the field in the request/response proto message.</p>
<p>It can be a string, a list of dict or a serializer.</p>
<p>1.String format</p>
<p>Inject directly the string as message. Usefull if you want to use a already declared custom message or some specific type like <code>google.protobuf.Empty</code>.</p>
<p>2.List of dict format</p>
<p>Transform the dict inside the list into proto field. Usefull if you have only 1 or 2 field and doesn't want to create a serializer
Dict format is:</p>
<pre><code class="language-python">{
    &quot;name&quot;: &quot;field_name&quot;,
    &quot;type&quot;: &quot;existing_protobuf_type&quot;
}
</code></pre>
<p>3.Serializer</p>
<p>Use a Serializer class to create the proto message in the same way that it work for know method.</p>
<p>Example:</p>
<pre><code class="language-python">class BasicServiceSerializer(proto_serializers.ProtoSerializer):

user_name = serializers.CharField()
user_data = serializers.DictField()

class Meta:
    fields = [&quot;user_name&quot;, &quot;user_data&quot;]

class BasicService(generics.GenericService):
    @grpc_action(
        request=[{&quot;name&quot;: &quot;user_name&quot;, &quot;type&quot;: &quot;string&quot;}],
        response=BasicServiceSerializer,
    )
    async def FetchDataForUser(self, request, context):
        pass
</code></pre>
<p>Generate:</p>
<pre><code class="language-proto">service BasicController {
    rpc FetchDataForUser(BasicFetchDataForUserRequest) returns (BasicServiceResponse) {}
}

message BasicFetchDataForUserRequest {
    string user_name = 1;
}

message BasicServiceResponse {
    string user_name = 1;
    google.protobuf.Struct user_data = 2;
}
</code></pre>
<h3 id="request_name-and-response_name-arg">request_name and response_name arg</h3>
<p>Used to force a name for the message used. </p>
<h3 id="request_stream-and-response_stream-arg">request_stream and response_stream arg</h3>
<p>Used to mark the request or the response as a stream in the protobuf file</p>
<h3 id="use_request_list-and-use_response_list-arg">use_request_list and use_response_list arg</h3>
<p>Used to encapsulate the message inside a List message.</p>
<p>You need to use it if you return a serializer message with many=True at initialisation</p>
<h2 id="force-message-for-know-method">Force message for know method</h2>
<p>You can use <code>grpc_action</code> decorator on know method to override default message.</p>
<pre><code class="language-python">class SomethingService(generics.AsyncModelService):
    queryset = SpecialFieldsModel.objects.all().order_by(&quot;uuid&quot;)
    serializer_class = SpecialFieldsModelSerializer

    @grpc_action(
        request=[{&quot;name&quot;: &quot;thing&quot;, &quot;type&quot;: &quot;string&quot;}],
        response=[{&quot;name&quot;: &quot;anything&quot;, &quot;type&quot;: &quot;string&quot;}],
    )
    async def Retrieve(self, request, context):
        pass
</code></pre>
<p>Generate:</p>
<pre><code class="language-proto">
import &quot;google/protobuf/empty.proto&quot;;

service SomethingController {
    ...
    rpc Retrieve(SomethingRetrieveRequest) returns (SomethingRetrieveResponse) {}
    ...
}

...

message SomethingRetrieveRequest {
    string thing = 1;
}

message SomethingRetrieveResponse {
    string anything = 1;
}

...
</code></pre>
<h2 id="read-only-and-write-only-props">Read Only and write only props</h2>
<p>If the settings <code>SEPARATE_READ_WRITE_MODEL</code> is true. Django Socio gRPC will automatically use read_only and write_only field kwargs to generate field only in request or response message.
This is also true for django field with specific value (editable=False or similar)</p>
<p>Example:</p>
<pre><code class="language-python">class BasicServiceSerializer(proto_serializers.ProtoSerializer):

    user_name = serializers.CharField(read_only=True)
    email = serializers.CharField()
    password = serializers.CharField(write_only=True)

    class Meta:
        fields = [&quot;user_name&quot;, &quot;email&quot;, &quot;password&quot;]
</code></pre>
<p>Generate a message like:</p>
<pre><code class="language-proto">message BasicServiceRequest {
    string user_name = 1;
    string password = 2;
}

message BasicServiceResponse {
    string user_name = 1;
    string email = 2;
}
</code></pre>
<h2 id="nested-serializer">Nested serializer</h2>
<p>Django Socio gRPC support nested serializer without no extra work. Just try it.</p>
<pre><code class="language-python">class RelatedFieldModelSerializer(proto_serializers.ModelProtoSerializer):
    foreign_obj = ForeignModelSerializer(read_only=True)
    many_many_obj = ManyManyModelSerializer(read_only=True, many=True)

    class Meta:
        model = RelatedFieldModel
        fields = [&quot;uuid&quot;, &quot;foreign_obj&quot;, &quot;many_many_obj&quot;]
</code></pre>
<pre><code class="language-proto">message RelatedFieldModelResponse {
    string uuid = 1;
    ForeignModelResponse foreign_obj = 2;
    repeated ManyManyModelResponse many_many_obj = 3;
}
</code></pre>
<h2 id="special-case-of-methodserializerfield">Special case of MethodSerializerField</h2>
<p>DRF MethodSerializerField class is a field type that return the result of a method. So there is no possibility to automatically find the type of this field.
To contourn this problem Django Socio gRPC introduce function introspection where we are looking for return annotation in the method to find the prototype</p>
<pre><code class="language-python">from typing import List, Disct

class ExampleSerializer(
    proto_serializers.ProtoSerializer
):

    default_method_field = serializers.SerializerMethodField()
    custom_method_field = serializers.SerializerMethodField(method_name=&quot;custom_method&quot;)

    def get_default_method_field(self, obj) -&gt; int:
        return 3

    def custom_method(self, obj) -&gt; List[Dict]:
        return [{&quot;test&quot;: &quot;test&quot;}]

    class Meta:
        fields = [&quot;default_method_field&quot;, &quot;custom_method_field&quot;]
</code></pre>
<pre><code class="language-proto">message ExampleResponse {
    int32 default_method_field = 2;
    repeated google.protobuf.Struct custom_method_field = 3;
}
</code></pre>
<h2 id="customizing-the-name-of-the-field-in-the-listresponse">Customizing the name of the field in the ListResponse</h2>
<p>By default the name of the field used for list response is <code>results</code>. You can override it in the meta of your serializer:</p>
<pre><code class="language-python">class ExampleSerializer(proto_serializers.ProtoSerializer):

    uuid = serializers.CharField()
    name = serializers.CharField()

    class Meta:
        message_list_attr = &quot;list_custom_field_name&quot;
        fields = [&quot;uuid&quot;, &quot;name&quot;]

</code></pre>
<pre><code class="language-proto">message ExampleResponse {
    string uuid = 1;
    string name = 2;
}

message ExampleListResponse {
    repeated ExampleResponse list_custom_field_name = 1;
    int32 count = 2;
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../generic_service/" class="btn btn-neutral float-right" title="Generic Service">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href=".." class="btn btn-neutral" title="Home"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href=".." style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../generic_service/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme_extra.js" defer></script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
